#include "STDTypeDefinition.h"
#include "NeuralNetLayer.h"
#include "NeuralNetLayerFunction.h"
#include "RandomValueGenerator.h"

//=====================================================================================
//  sigmoid関数
//=====================================================================================
//　y= 1/(1+exp(-x))-0.5
//  x: 0.0 〜 0.5 (0.01*i)
//=====================================================================================
//#define USE_MATH_SIGMOID
#ifdef USE_MATH_SIGMOID
#include "math.h"
#endif

#define SIGMOID_TABLE_SIZE         (1025)
#define SIGMOID_TABLE_DELTA_X      (0.01f)
#define SIGMOID_TABLE_INV_DELTA_X  (100.0f)
static const flt32_t HALF_SIGMOID_TABLE[SIGMOID_TABLE_SIZE] = {
0.000000000f,0.002499979f,0.004999833f,0.007499437f,0.009998667f,0.012497395f,0.014995501f,0.017492857f,0.019989340f,0.022484824f,
0.024979185f,0.027472304f,0.029964050f,0.032454304f,0.034942944f,0.037429843f,0.039914884f,0.042397942f,0.044878889f,0.047357619f,
0.049833994f,0.052307907f,0.054779235f,0.057247851f,0.059713647f,0.062176500f,0.064636290f,0.067092903f,0.069546223f,0.071996130f,
0.074442513f,0.076885261f,0.079324253f,0.081759371f,0.084190525f,0.086617574f,0.089040428f,0.091458976f,0.093873098f,0.096282698f,
0.098687656f,0.101087876f,0.103483245f,0.105873667f,0.108259030f,0.110639229f,0.113014169f,0.115383759f,0.117747873f,0.120106429f,
0.122459330f,0.124806471f,0.127147764f,0.129483104f,0.131812409f,0.134135589f,0.136452541f,0.138763174f,0.141067401f,0.143365145f,
0.145656303f,0.147940800f,0.150218546f,0.152489468f,0.154753461f,0.157010451f,0.159260377f,0.161503151f,0.163738698f,0.165966928f,
0.168187767f,0.170401156f,0.172607005f,0.174805269f,0.176995859f,0.179178700f,0.181353733f,0.183520883f,0.185680106f,0.187831327f,
0.189974472f,0.192109510f,0.194236338f,0.196354926f,0.198465213f,0.200567141f,0.202660650f,0.204745695f,0.206822217f,0.208890170f,
0.210949495f,0.213000149f,0.215042099f,0.217075288f,0.219099656f,0.221115172f,0.223121807f,0.225119486f,0.227108210f,0.229087919f,
0.231058583f,0.233020142f,0.234972596f,0.236915886f,0.238849998f,0.240774885f,0.242690533f,0.244596899f,0.246493965f,0.248381734f,
0.250260115f,0.252129108f,0.253988713f,0.255838901f,0.257679641f,0.259510905f,0.261332721f,0.263145000f,0.264947802f,0.266741067f,
0.268524766f,0.270298928f,0.272063553f,0.273818582f,0.275564015f,0.277299851f,0.279026121f,0.280742735f,0.282449782f,0.284147173f,
0.285834968f,0.287513137f,0.289181709f,0.290840626f,0.292489916f,0.294129640f,0.295759708f,0.297380149f,0.298990995f,0.300592244f,
0.302183896f,0.303765953f,0.305338413f,0.306901306f,0.308454633f,0.309998423f,0.311532676f,0.313057363f,0.314572573f,0.316078275f,
0.317574471f,0.319061220f,0.320538491f,0.322006315f,0.323464721f,0.324913710f,0.326353341f,0.327783585f,0.329204500f,0.330616087f,
0.332018375f,0.333411396f,0.334795117f,0.336169630f,0.337534934f,0.338891059f,0.340238005f,0.341575801f,0.342904538f,0.344224155f,
0.345534712f,0.346836269f,0.348128825f,0.349412411f,0.350687057f,0.351952791f,0.353209645f,0.354457676f,0.355696857f,0.356927276f,
0.358148932f,0.359361857f,0.360566109f,0.361761719f,0.362948686f,0.364127100f,0.365296960f,0.366458267f,0.367611140f,0.368755519f,
0.369891524f,0.371019155f,0.372138441f,0.373249412f,0.374352127f,0.375446647f,0.376532942f,0.377611101f,0.378681153f,0.379743129f,
0.380797088f,0.381843030f,0.382881016f,0.383911073f,0.384933263f,0.385947615f,0.386954159f,0.387952954f,0.388944030f,0.389927417f,
0.390903175f,0.391871333f,0.392831922f,0.393785000f,0.394730598f,0.395668775f,0.396599531f,0.397522956f,0.398439080f,0.399347901f,
0.400249511f,0.401143938f,0.402031213f,0.402911365f,0.403784454f,0.404650539f,0.405509621f,0.406361789f,0.407207042f,0.408045441f,
0.408877045f,0.409701854f,0.410519928f,0.411331326f,0.412136078f,0.412934214f,0.413725793f,0.414510846f,0.415289432f,0.416061550f,
0.416827291f,0.417586684f,0.418339729f,0.419086516f,0.419827104f,0.420561463f,0.421289653f,0.422011763f,0.422727793f,0.423437804f,
0.424141824f,0.424839884f,0.425532043f,0.426218361f,0.426898837f,0.427573502f,0.428242445f,0.428905696f,0.429563254f,0.430215210f,
0.430861562f,0.431502402f,0.432137698f,0.432767540f,0.433391958f,0.434010983f,0.434624672f,0.435233027f,0.435836107f,0.436433971f,
0.437026650f,0.437614143f,0.438196540f,0.438773841f,0.439346105f,0.439913362f,0.440475643f,0.441032976f,0.441585451f,0.442133039f,
0.442675829f,0.443213820f,0.443747073f,0.444275588f,0.444799453f,0.445318669f,0.445833296f,0.446343333f,0.446848869f,0.447349876f,
0.447846442f,0.448338568f,0.448826283f,0.449309677f,0.449788719f,0.450263500f,0.450733989f,0.451200277f,0.451662362f,0.452120304f,
0.452574134f,0.453023851f,0.453469515f,0.453911185f,0.454348832f,0.454782516f,0.455212295f,0.455638170f,0.456060171f,0.456478357f,
0.456892729f,0.457303345f,0.457710236f,0.458113402f,0.458512872f,0.458908707f,0.459300935f,0.459689587f,0.460074663f,0.460456222f,
0.460834265f,0.461208880f,0.461580008f,0.461947739f,0.462312102f,0.462673098f,0.463030785f,0.463385165f,0.463736296f,0.464084148f,
0.464428812f,0.464770287f,0.465108603f,0.465443760f,0.465775847f,0.466104835f,0.466430783f,0.466753691f,0.467073590f,0.467390537f,
0.467704535f,0.468015611f,0.468323767f,0.468629062f,0.468931496f,0.469231129f,0.469527960f,0.469822019f,0.470113307f,0.470401883f,
0.470687777f,0.470970958f,0.471251518f,0.471529424f,0.471804708f,0.472077429f,0.472347587f,0.472615182f,0.472880274f,0.473142892f,
0.473403007f,0.473660678f,0.473915935f,0.474168748f,0.474419206f,0.474667281f,0.474913031f,0.475156456f,0.475397557f,0.475636393f,
0.475872964f,0.476107299f,0.476339430f,0.476569325f,0.476797074f,0.477022618f,0.477246046f,0.477467358f,0.477686554f,0.477903664f,
0.478118718f,0.478331745f,0.478542715f,0.478751689f,0.478958637f,0.479163647f,0.479366690f,0.479567796f,0.479766995f,0.479964286f,
0.480159700f,0.480353236f,0.480544925f,0.480734766f,0.480922788f,0.481109023f,0.481293499f,0.481476188f,0.481657118f,0.481836319f,
0.482013792f,0.482189566f,0.482363671f,0.482536077f,0.482706845f,0.482875973f,0.483043462f,0.483209342f,0.483373642f,0.483536363f,
0.483697504f,0.483857095f,0.484015137f,0.484171689f,0.484326720f,0.484480232f,0.484632283f,0.484782875f,0.484932005f,0.485079706f,
0.485225976f,0.485370815f,0.485514283f,0.485656351f,0.485797048f,0.485936373f,0.486074358f,0.486211002f,0.486346334f,0.486480355f,
0.486613065f,0.486744523f,0.486874670f,0.487003595f,0.487131238f,0.487257659f,0.487382829f,0.487506807f,0.487629592f,0.487751156f,
0.487871557f,0.487990797f,0.488108873f,0.488225788f,0.488341570f,0.488456249f,0.488569796f,0.488682240f,0.488793582f,0.488903850f,
0.489013046f,0.489121199f,0.489228278f,0.489334315f,0.489439309f,0.489543289f,0.489646256f,0.489748240f,0.489849210f,0.489949197f,
0.490048200f,0.490146250f,0.490243345f,0.490339488f,0.490434676f,0.490528971f,0.490622312f,0.490714759f,0.490806282f,0.490896940f,
0.490986705f,0.491075575f,0.491163611f,0.491250753f,0.491337061f,0.491422504f,0.491507143f,0.491590917f,0.491673917f,0.491756082f,
0.491837412f,0.491917998f,0.491997749f,0.492076755f,0.492154986f,0.492232442f,0.492309123f,0.492385060f,0.492460281f,0.492534727f,
0.492608458f,0.492681473f,0.492753774f,0.492825329f,0.492896229f,0.492966413f,0.493035913f,0.493104726f,0.493172854f,0.493240327f,
0.493307143f,0.493373305f,0.493438810f,0.493503660f,0.493567884f,0.493631482f,0.493694454f,0.493756801f,0.493818551f,0.493879676f,
0.493940204f,0.494000137f,0.494059473f,0.494118243f,0.494176418f,0.494234025f,0.494291067f,0.494347572f,0.494403481f,0.494458854f,
0.494513690f,0.494567990f,0.494621754f,0.494674981f,0.494727701f,0.494779885f,0.494831532f,0.494882703f,0.494933367f,0.494983524f,
0.495033205f,0.495082378f,0.495131075f,0.495179296f,0.495227009f,0.495274276f,0.495321095f,0.495367438f,0.495413303f,0.495458752f,
0.495503724f,0.495548278f,0.495592356f,0.495636046f,0.495679259f,0.495722085f,0.495764464f,0.495806426f,0.495847970f,0.495889127f,
0.495929867f,0.495970190f,0.496010125f,0.496049672f,0.496088833f,0.496127605f,0.496165991f,0.496203989f,0.496241599f,0.496278882f,
0.496315747f,0.496352285f,0.496388435f,0.496424258f,0.496459723f,0.496494800f,0.496529579f,0.496563971f,0.496598065f,0.496631801f,
0.496665180f,0.496698260f,0.496731013f,0.496763438f,0.496795535f,0.496827304f,0.496858776f,0.496889949f,0.496920794f,0.496951342f,
0.496981591f,0.497011542f,0.497041166f,0.497070521f,0.497099578f,0.497128367f,0.497156858f,0.497185081f,0.497213006f,0.497240663f,
0.497268051f,0.497295141f,0.497321993f,0.497348577f,0.497374892f,0.497400939f,0.497426718f,0.497452259f,0.497477561f,0.497502595f,
0.497527391f,0.497551918f,0.497576207f,0.497600287f,0.497624099f,0.497647673f,0.497671038f,0.497694165f,0.497717053f,0.497739702f,
0.497762144f,0.497784376f,0.497806370f,0.497828156f,0.497849703f,0.497871071f,0.497892201f,0.497913122f,0.497933835f,0.497954369f,
0.497974694f,0.497994781f,0.498014718f,0.498034418f,0.498053938f,0.498073280f,0.498092413f,0.498111337f,0.498130113f,0.498148680f,
0.498167068f,0.498185277f,0.498203278f,0.498221129f,0.498238802f,0.498256296f,0.498273611f,0.498290777f,0.498307735f,0.498324543f,
0.498341203f,0.498357683f,0.498373985f,0.498390138f,0.498406142f,0.498421967f,0.498437643f,0.498453170f,0.498468548f,0.498483747f,
0.498498827f,0.498513728f,0.498528510f,0.498543113f,0.498557597f,0.498571932f,0.498586118f,0.498600155f,0.498614073f,0.498627841f,
0.498641491f,0.498654991f,0.498668343f,0.498681575f,0.498694688f,0.498707652f,0.498720497f,0.498733222f,0.498745799f,0.498758256f,
0.498770595f,0.498782814f,0.498794913f,0.498806894f,0.498818755f,0.498830497f,0.498842120f,0.498853624f,0.498865008f,0.498876303f,
0.498887450f,0.498898536f,0.498909473f,0.498920321f,0.498931050f,0.498941660f,0.498952180f,0.498962611f,0.498972923f,0.498983115f,
0.498993218f,0.499003232f,0.499013156f,0.499022961f,0.499032676f,0.499042273f,0.499051809f,0.499061227f,0.499070555f,0.499079794f,
0.499088943f,0.499098003f,0.499106973f,0.499115855f,0.499124646f,0.499133348f,0.499141961f,0.499150485f,0.499158949f,0.499167293f,
0.499175578f,0.499183774f,0.499191880f,0.499199927f,0.499207884f,0.499215752f,0.499223560f,0.499231279f,0.499238908f,0.499246478f,
0.499253958f,0.499261379f,0.499268740f,0.499276012f,0.499283195f,0.499290317f,0.499297380f,0.499304384f,0.499311298f,0.499318123f,
0.499324918f,0.499331623f,0.499338269f,0.499344856f,0.499351382f,0.499357820f,0.499364197f,0.499370515f,0.499376774f,0.499382973f,
0.499389112f,0.499395192f,0.499401212f,0.499407172f,0.499413073f,0.499418885f,0.499424666f,0.499430388f,0.499436051f,0.499441683f,
0.499447227f,0.499452710f,0.499458164f,0.499463558f,0.499468893f,0.499474168f,0.499479383f,0.499484569f,0.499489695f,0.499494761f,
0.499499798f,0.499504775f,0.499509692f,0.499514580f,0.499519408f,0.499524176f,0.499528915f,0.499533594f,0.499538243f,0.499542832f,
0.499547392f,0.499551892f,0.499556333f,0.499560744f,0.499565125f,0.499569446f,0.499573737f,0.499577969f,0.499582171f,0.499586314f,
0.499590427f,0.499594510f,0.499598533f,0.499602526f,0.499606490f,0.499610394f,0.499614269f,0.499618113f,0.499621898f,0.499625683f,
0.499629408f,0.499633074f,0.499636739f,0.499640346f,0.499643922f,0.499647468f,0.499650955f,0.499654442f,0.499657869f,0.499661267f,
0.499664664f,0.499667972f,0.499671280f,0.499674559f,0.499677807f,0.499680996f,0.499684185f,0.499687314f,0.499690413f,0.499693513f,
0.499696553f,0.499699563f,0.499702573f,0.499705523f,0.499708444f,0.499711335f,0.499714226f,0.499717057f,0.499719888f,0.499722660f,
0.499725431f,0.499728143f,0.499730855f,0.499733537f,0.499736190f,0.499738812f,0.499741405f,0.499743968f,0.499746531f,0.499749035f,
0.499751538f,0.499754012f,0.499756455f,0.499758899f,0.499761283f,0.499763668f,0.499766022f,0.499768347f,0.499770641f,0.499772936f,
0.499775171f,0.499777406f,0.499779642f,0.499781817f,0.499783993f,0.499786139f,0.499788284f,0.499790370f,0.499792457f,0.499794543f,
0.499796569f,0.499798596f,0.499800593f,0.499802589f,0.499804556f,0.499806494f,0.499808431f,0.499810338f,0.499812216f,0.499814093f,
0.499815941f,0.499817759f,0.499819577f,0.499821365f,0.499823153f,0.499824911f,0.499826640f,0.499828368f,0.499830067f,0.499831766f,
0.499833435f,0.499835104f,0.499836743f,0.499838352f,0.499839962f,0.499841571f,0.499843150f,0.499844700f,0.499846250f,0.499847770f,
0.499849290f,0.499850780f,0.499852270f,0.499853730f,0.499855191f,0.499856651f,0.499858052f,0.499859482f,0.499860883f,0.499862254f,
0.499863625f,0.499864995f,0.499866337f,0.499867648f,0.499868989f,0.499870270f,0.499871582f,0.499872833f,0.499874115f,0.499875367f,
0.499876618f,0.499877840f,0.499879062f,0.499880254f,0.499881446f,0.499882609f,0.499883801f,0.499884933f,0.499886096f,0.499887228f,
0.499888361f,0.499889463f,0.499890566f,0.499891639f,0.499892712f,0.499893785f,0.499894857f,0.499895900f,0.499896944f,0.499897957f,
0.499898970f,0.499899983f,0.499900967f,0.499901950f,0.499902934f,0.499903888f,0.499904841f,0.499905795f,0.499906749f,0.499907672f,
0.499908596f,0.499909490f,0.499910384f,0.499911278f,0.499912173f,0.499913037f,0.499913901f,0.499914765f,0.499915600f,0.499916464f,
0.499917269f,0.499918103f,0.499918908f,0.499919713f,0.499920517f,0.499921322f,0.499922097f,0.499922872f,0.499923646f,0.499924392f,
0.499925166f,0.499925911f,0.499926627f,0.499927372f,0.499928087f,0.499928802f,0.499929518f,0.499930203f,0.499930918f,0.499931604f,
0.499932289f,0.499932945f,0.499933630f,0.499934286f,0.499934942f,0.499935567f,0.499936223f,0.499936849f,0.499937475f,0.499938101f,
0.499938726f,0.499939322f,0.499939948f,0.499940544f,0.499941111f,0.499941707f,0.499942303f,0.499942869f,0.499943435f,0.499944001f,
0.499944538f,0.499945104f,0.499945641f,0.499946177f,0.499946713f,0.499947250f,0.499947786f,0.499948293f,0.499948800f,0.499949336f,
0.499949843f,0.499950320f,0.499950826f,0.499951303f,0.499951810f,0.499952286f,0.499952763f,0.499953210f,0.499953687f,0.499954134f,
0.499954611f,0.499955058f,0.499955505f,0.499955952f,0.499956369f,0.499956816f,0.499957234f,0.499957681f,0.499958098f,0.499958515f,
0.499958932f,0.499959320f,0.499959737f,0.499960124f,0.499960542f,0.499960929f,0.499961317f,0.499961704f,0.499962091f,0.499962449f,
0.499962837f,0.499963194f,0.499963582f,0.499963939f,0.499964297f,
};

static
flt32_t
sigmoid(flt32_t x)
{
	flt32_t		X;
	flt32_t		Y;
	uint32_t	tableIndex1;
	uint32_t	tableIndex2;
	flt32_t		X1;
	flt32_t		Y1;
	flt32_t		Y2;
#ifdef USE_MATH_SIGMOID
	return (1.0f/(1.0f+exp(-x)));
#else
	if (x < 0.0f) {
		X = -x;
	}
	else {
		X = x;
	}
	tableIndex1 = (uint32_t)(X * SIGMOID_TABLE_INV_DELTA_X);
	tableIndex2 = tableIndex1 + 1;
	if (tableIndex2 >= SIGMOID_TABLE_SIZE) {
		Y = 0.5f;
	}
	else {
		//---------------------------------------------------------------------------------------------------------------
		// 補完計算
		// テーブルの最終半分をクリップして半分のサイズにすると逆伝播での性能が得られなかった。
		//---------------------------------------------------------------------------------------------------------------
		X1 = SIGMOID_TABLE_DELTA_X * (flt32_t)tableIndex1;
		Y1 = (flt32_t)HALF_SIGMOID_TABLE[tableIndex1];
		Y2 = (flt32_t)HALF_SIGMOID_TABLE[tableIndex2];
		Y = (Y2 - Y1) * SIGMOID_TABLE_INV_DELTA_X * (X - X1) + Y1;
	}
	if (x > 0.0f) {
		Y = 0.5f + Y;
	}
	else {
		Y = 0.5f - Y;
	}
#endif
	return Y;
}

//=====================================================================================
//  softmax関数
//=====================================================================================
//　y= exp(x)
//  x: -16.0 〜 0.0 (0.015625f*i-16.0)
//=====================================================================================
//#define USE_MATH_SOFTMAX_EXP_FUNCTION
#ifdef USE_MATH_SOFTMAX_EXP_FUNCTION
#include "math.h"
#endif

#define NEGATIVE_X_EXP_THRESHOLD      (-16.0f)
#define NEGATIVE_X_EXP_TABLE_SIZE	  (1025)
#define NEGATIVE_X_EXP_DELTA_X        (0.015625f)  //NEGATIVE_X_EXP_THRESHOLD / (NEGATIVE_X_EXP_TABLE_SIZE-1)
#define NEGATIVE_X_EXP_INV_DELTA_X    (64.0f)      //1.0/NEGATIVE_X_EXP_DELTA_X
#define NEGATIVE_X_EXP_MIN_VALUE      (0.0f)
#define NEGATIVE_X_EXP_MAX_VALUE      (1.0f)
static const flt32_t NEGATIVE_X_EXP_TABLE[NEGATIVE_X_EXP_TABLE_SIZE] = {
1.000000000f,0.984496415f,0.969233215f,0.954206645f,0.939413071f,0.924848795f,0.910510361f,0.896394193f,0.882496893f,0.868815064f,
0.855345309f,0.842084408f,0.829029143f,0.816176236f,0.803522587f,0.791065097f,0.778800786f,0.766726613f,0.754839599f,0.743136883f,
0.731615603f,0.720272958f,0.709106207f,0.698112488f,0.687289298f,0.676633835f,0.666143596f,0.655816019f,0.645648539f,0.635638654f,
0.625783980f,0.616082132f,0.606530666f,0.597127259f,0.587869644f,0.578755617f,0.569782853f,0.560949147f,0.552252471f,0.543690562f,
0.535261452f,0.526962996f,0.518793166f,0.510749996f,0.502831578f,0.495035887f,0.487361073f,0.479805231f,0.472366542f,0.465043187f,
0.457833350f,0.450735301f,0.443747312f,0.436867654f,0.430094630f,0.423426628f,0.416862011f,0.410399169f,0.404036522f,0.397772521f,
0.391605616f,0.385534346f,0.379557192f,0.373672694f,0.367879450f,0.362176001f,0.356560975f,0.351033002f,0.345590740f,0.340232879f,
0.334958047f,0.329764992f,0.324652463f,0.319619209f,0.314663947f,0.309785545f,0.304982781f,0.300254434f,0.295599431f,0.291016579f,
0.286504805f,0.282062948f,0.277689964f,0.273384780f,0.269146353f,0.264973611f,0.260865599f,0.256821245f,0.252839595f,0.248919681f,
0.245060533f,0.241261229f,0.237520814f,0.233838394f,0.230213076f,0.226643950f,0.223130167f,0.219670847f,0.216265172f,0.212912291f,
0.209611386f,0.206361666f,0.203162327f,0.200012580f,0.196911678f,0.193858847f,0.190853342f,0.187894434f,0.184981406f,0.182113528f,
0.179290116f,0.176510483f,0.173773944f,0.171079829f,0.168427482f,0.165816262f,0.163245514f,0.160714626f,0.158222973f,0.155769959f,
0.153354973f,0.150977418f,0.148636729f,0.146332338f,0.144063666f,0.141830161f,0.139631286f,0.137466505f,0.135335281f,0.133237109f,
0.131171450f,0.129137829f,0.127135739f,0.125164673f,0.123224176f,0.121313766f,0.119432971f,0.117581330f,0.115758404f,0.113963738f,
0.112196892f,0.110457435f,0.108744957f,0.107059024f,0.105399221f,0.103765160f,0.102156430f,0.100572646f,0.099013411f,0.097478345f,
0.095967084f,0.094479255f,0.093014486f,0.091572434f,0.090152733f,0.088755049f,0.087379023f,0.086024337f,0.084690653f,0.083377652f,
0.082084998f,0.080812387f,0.079559512f,0.078326054f,0.077111721f,0.075916216f,0.074739240f,0.073580518f,0.072439760f,0.071316682f,
0.070211023f,0.069122501f,0.068050854f,0.066995822f,0.065957151f,0.064934582f,0.063927859f,0.062936753f,0.061961006f,0.061000392f,
0.060054667f,0.059123605f,0.058206979f,0.057304565f,0.056416139f,0.055541489f,0.054680396f,0.053832658f,0.052998058f,0.052176401f,
0.051367480f,0.050571099f,0.049787067f,0.049015190f,0.048255280f,0.047507152f,0.046770621f,0.046045512f,0.045331642f,0.044628840f,
0.043936934f,0.043255754f,0.042585135f,0.041924916f,0.041274928f,0.040635020f,0.040005032f,0.039384812f,0.038774207f,0.038173068f,
0.037581250f,0.036998607f,0.036424998f,0.035860281f,0.035304319f,0.034756977f,0.034218118f,0.033687614f,0.033165336f,0.032651156f,
0.032144949f,0.031646587f,0.031155951f,0.030672923f,0.030197384f,0.029729217f,0.029268308f,0.028814545f,0.028367816f,0.027928013f,
0.027495030f,0.027068760f,0.026649097f,0.026235942f,0.025829190f,0.025428746f,0.025034510f,0.024646387f,0.024264280f,0.023888096f,
0.023517746f,0.023153137f,0.022794181f,0.022440789f,0.022092877f,0.021750359f,0.021413151f,0.021081172f,0.020754337f,0.020432571f,
0.020115795f,0.019803928f,0.019496895f,0.019194625f,0.018897040f,0.018604068f,0.018315639f,0.018031681f,0.017752126f,0.017476905f,
0.017205950f,0.016939197f,0.016676579f,0.016418032f,0.016163494f,0.015912903f,0.015666196f,0.015423315f,0.015184198f,0.014948789f,
0.014717029f,0.014488863f,0.014264234f,0.014043087f,0.013825370f,0.013611027f,0.013400008f,0.013192260f,0.012987733f,0.012786376f,
0.012588142f,0.012392981f,0.012200845f,0.012011689f,0.011825466f,0.011642128f,0.011461634f,0.011283938f,0.011108996f,0.010936768f,
0.010767208f,0.010600278f,0.010435936f,0.010274142f,0.010114856f,0.009958040f,0.009803655f,0.009651664f,0.009502028f,0.009354713f,
0.009209681f,0.009066898f,0.008926329f,0.008787939f,0.008651695f,0.008517563f,0.008385510f,0.008255505f,0.008127515f,0.008001510f,
0.007877458f,0.007755329f,0.007635094f,0.007516723f,0.007400187f,0.007285458f,0.007172507f,0.007061308f,0.006951832f,0.006844054f,
0.006737947f,0.006633485f,0.006530642f,0.006429394f,0.006329715f,0.006231582f,0.006134971f,0.006039856f,0.005946218f,0.005854030f,
0.005763271f,0.005673920f,0.005585954f,0.005499352f,0.005414092f,0.005330155f,0.005247518f,0.005166163f,0.005086069f,0.005007217f,
0.004929587f,0.004853161f,0.004777920f,0.004703845f,0.004630919f,0.004559123f,0.004488440f,0.004418854f,0.004350346f,0.004282900f,
0.004216500f,0.004151129f,0.004086772f,0.004023412f,0.003961035f,0.003899625f,0.003839166f,0.003779646f,0.003721048f,0.003663358f,
0.003606563f,0.003550648f,0.003495601f,0.003441407f,0.003388053f,0.003335526f,0.003283813f,0.003232902f,0.003182781f,0.003133436f,
0.003084857f,0.003037031f,0.002989946f,0.002943591f,0.002897955f,0.002853026f,0.002808794f,0.002765248f,0.002722377f,0.002680170f,
0.002638618f,0.002597710f,0.002557436f,0.002517787f,0.002478752f,0.002440323f,0.002402489f,0.002365242f,0.002328572f,0.002292471f,
0.002256930f,0.002221939f,0.002187491f,0.002153577f,0.002120189f,0.002087319f,0.002054958f,0.002023099f,0.001991733f,0.001960854f,
0.001930454f,0.001900525f,0.001871060f,0.001842052f,0.001813494f,0.001785378f,0.001757698f,0.001730448f,0.001703620f,0.001677208f,
0.001651205f,0.001625605f,0.001600403f,0.001575591f,0.001551163f,0.001527115f,0.001503439f,0.001480130f,0.001457183f,0.001434592f,
0.001412350f,0.001390454f,0.001368897f,0.001347674f,0.001326780f,0.001306211f,0.001285960f,0.001266023f,0.001246395f,0.001227071f,
0.001208047f,0.001189318f,0.001170880f,0.001152727f,0.001134855f,0.001117261f,0.001099940f,0.001082887f,0.001066098f,0.001049570f,
0.001033298f,0.001017278f,0.001001506f,0.000985979f,0.000970693f,0.000955644f,0.000940828f,0.000926242f,0.000911882f,0.000897745f,
0.000883826f,0.000870124f,0.000856634f,0.000843353f,0.000830278f,0.000817406f,0.000804733f,0.000792257f,0.000779974f,0.000767882f,
0.000755977f,0.000744256f,0.000732718f,0.000721358f,0.000710174f,0.000699164f,0.000688325f,0.000677653f,0.000667147f,0.000656804f,
0.000646621f,0.000636596f,0.000626727f,0.000617010f,0.000607444f,0.000598027f,0.000588755f,0.000579627f,0.000570641f,0.000561794f,
0.000553084f,0.000544510f,0.000536068f,0.000527757f,0.000519575f,0.000511519f,0.000503589f,0.000495782f,0.000488095f,0.000480528f,
0.000473078f,0.000465744f,0.000458523f,0.000451414f,0.000444416f,0.000437526f,0.000430743f,0.000424064f,0.000417490f,0.000411017f,
0.000404645f,0.000398372f,0.000392196f,0.000386115f,0.000380129f,0.000374236f,0.000368434f,0.000362722f,0.000357098f,0.000351562f,
0.000346111f,0.000340745f,0.000335463f,0.000330262f,0.000325142f,0.000320101f,0.000315138f,0.000310252f,0.000305442f,0.000300707f,
0.000296045f,0.000291455f,0.000286936f,0.000282488f,0.000278108f,0.000273797f,0.000269552f,0.000265373f,0.000261259f,0.000257208f,
0.000253220f,0.000249295f,0.000245430f,0.000241625f,0.000237879f,0.000234191f,0.000230560f,0.000226985f,0.000223466f,0.000220002f,
0.000216591f,0.000213233f,0.000209927f,0.000206673f,0.000203468f,0.000200314f,0.000197208f,0.000194151f,0.000191141f,0.000188177f,
0.000185260f,0.000182388f,0.000179560f,0.000176776f,0.000174036f,0.000171338f,0.000168681f,0.000166066f,0.000163491f,0.000160957f,
0.000158461f,0.000156005f,0.000153586f,0.000151205f,0.000148861f,0.000146553f,0.000144281f,0.000142044f,0.000139842f,0.000137674f,
0.000135539f,0.000133438f,0.000131369f,0.000129332f,0.000127327f,0.000125353f,0.000123410f,0.000121497f,0.000119613f,0.000117758f,
0.000115933f,0.000114135f,0.000112366f,0.000110624f,0.000108909f,0.000107220f,0.000105558f,0.000103921f,0.000102310f,0.000100724f,
0.000099163f,0.000097625f,0.000096112f,0.000094622f,0.000093155f,0.000091710f,0.000090289f,0.000088889f,0.000087511f,0.000086154f,
0.000084818f,0.000083503f,0.000082209f,0.000080934f,0.000079679f,0.000078444f,0.000077228f,0.000076031f,0.000074852f,0.000073691f,
0.000072549f,0.000071424f,0.000070317f,0.000069227f,0.000068153f,0.000067097f,0.000066057f,0.000065032f,0.000064024f,0.000063032f,
0.000062054f,0.000061092f,0.000060145f,0.000059213f,0.000058295f,0.000057391f,0.000056501f,0.000055625f,0.000054763f,0.000053914f,
0.000053078f,0.000052255f,0.000051445f,0.000050647f,0.000049862f,0.000049089f,0.000048328f,0.000047579f,0.000046841f,0.000046115f,
0.000045400f,0.000044696f,0.000044003f,0.000043321f,0.000042649f,0.000041988f,0.000041337f,0.000040696f,0.000040065f,0.000039444f,
0.000038833f,0.000038231f,0.000037638f,0.000037054f,0.000036480f,0.000035914f,0.000035358f,0.000034809f,0.000034270f,0.000033738f,
0.000033215f,0.000032700f,0.000032193f,0.000031694f,0.000031203f,0.000030719f,0.000030243f,0.000029774f,0.000029312f,0.000028858f,
0.000028411f,0.000027970f,0.000027536f,0.000027110f,0.000026689f,0.000026275f,0.000025868f,0.000025467f,0.000025072f,0.000024684f,
0.000024301f,0.000023924f,0.000023553f,0.000023188f,0.000022829f,0.000022475f,0.000022126f,0.000021783f,0.000021445f,0.000021113f,
0.000020786f,0.000020463f,0.000020146f,0.000019834f,0.000019526f,0.000019224f,0.000018926f,0.000018632f,0.000018343f,0.000018059f,
0.000017779f,0.000017503f,0.000017232f,0.000016965f,0.000016702f,0.000016443f,0.000016188f,0.000015937f,0.000015690f,0.000015447f,
0.000015207f,0.000014971f,0.000014739f,0.000014511f,0.000014286f,0.000014064f,0.000013846f,0.000013632f,0.000013420f,0.000013212f,
0.000013007f,0.000012806f,0.000012607f,0.000012412f,0.000012219f,0.000012030f,0.000011843f,0.000011660f,0.000011479f,0.000011301f,
0.000011126f,0.000010953f,0.000010783f,0.000010616f,0.000010452f,0.000010290f,0.000010130f,0.000009973f,0.000009818f,0.000009666f,
0.000009516f,0.000009369f,0.000009224f,0.000009081f,0.000008940f,0.000008801f,0.000008665f,0.000008530f,0.000008398f,0.000008268f,
0.000008140f,0.000008014f,0.000007889f,0.000007767f,0.000007647f,0.000007528f,0.000007411f,0.000007296f,0.000007183f,0.000007072f,
0.000006962f,0.000006854f,0.000006748f,0.000006643f,0.000006540f,0.000006439f,0.000006339f,0.000006241f,0.000006144f,0.000006049f,
0.000005955f,0.000005863f,0.000005772f,0.000005682f,0.000005594f,0.000005508f,0.000005422f,0.000005338f,0.000005255f,0.000005174f,
0.000005094f,0.000005015f,0.000004937f,0.000004860f,0.000004785f,0.000004711f,0.000004638f,0.000004566f,0.000004495f,0.000004426f,
0.000004357f,0.000004289f,0.000004223f,0.000004157f,0.000004093f,0.000004029f,0.000003967f,0.000003905f,0.000003845f,0.000003785f,
0.000003727f,0.000003669f,0.000003612f,0.000003556f,0.000003501f,0.000003447f,0.000003393f,0.000003341f,0.000003289f,0.000003238f,
0.000003188f,0.000003138f,0.000003090f,0.000003042f,0.000002994f,0.000002948f,0.000002902f,0.000002857f,0.000002813f,0.000002769f,
0.000002726f,0.000002684f,0.000002643f,0.000002602f,0.000002561f,0.000002522f,0.000002482f,0.000002444f,0.000002406f,0.000002369f,
0.000002332f,0.000002296f,0.000002260f,0.000002225f,0.000002191f,0.000002157f,0.000002123f,0.000002090f,0.000002058f,0.000002026f,
0.000001995f,0.000001964f,0.000001933f,0.000001903f,0.000001874f,0.000001845f,0.000001816f,0.000001788f,0.000001760f,0.000001733f,
0.000001706f,0.000001680f,0.000001654f,0.000001628f,0.000001603f,0.000001578f,0.000001554f,0.000001529f,0.000001506f,0.000001482f,
0.000001459f,0.000001437f,0.000001414f,0.000001393f,0.000001371f,0.000001350f,0.000001329f,0.000001308f,0.000001288f,0.000001268f,
0.000001248f,0.000001229f,0.000001210f,0.000001191f,0.000001173f,0.000001154f,0.000001137f,0.000001119f,0.000001102f,0.000001085f,
0.000001068f,0.000001051f,0.000001035f,0.000001019f,0.000001003f,0.000000987f,0.000000972f,0.000000957f,0.000000942f,0.000000928f,
0.000000913f,0.000000899f,0.000000885f,0.000000871f,0.000000858f,0.000000845f,0.000000832f,0.000000819f,0.000000806f,0.000000793f,
0.000000781f,0.000000769f,0.000000757f,0.000000745f,0.000000734f,0.000000722f,0.000000711f,0.000000700f,0.000000689f,0.000000679f,
0.000000668f,0.000000658f,0.000000648f,0.000000638f,0.000000628f,0.000000618f,0.000000608f,0.000000599f,0.000000590f,0.000000581f,
0.000000572f,0.000000563f,0.000000554f,0.000000545f,0.000000537f,0.000000529f,0.000000520f,0.000000512f,0.000000504f,0.000000497f,
0.000000489f,0.000000481f,0.000000474f,0.000000466f,0.000000459f,0.000000452f,0.000000445f,0.000000438f,0.000000431f,0.000000425f,
0.000000418f,0.000000412f,0.000000405f,0.000000399f,0.000000393f,0.000000387f,0.000000381f,0.000000375f,0.000000369f,0.000000363f,
0.000000358f,0.000000352f,0.000000347f,0.000000341f,0.000000336f,0.000000331f,0.000000326f,0.000000321f,0.000000316f,0.000000311f,
0.000000306f,0.000000301f,0.000000296f,0.000000292f,0.000000287f,0.000000283f,0.000000279f,0.000000274f,0.000000270f,0.000000266f,
0.000000262f,0.000000258f,0.000000254f,0.000000250f,0.000000246f,0.000000242f,0.000000238f,0.000000235f,0.000000231f,0.000000227f,
0.000000224f,0.000000220f,0.000000217f,0.000000214f,0.000000210f,0.000000207f,0.000000204f,0.000000201f,0.000000198f,0.000000194f,
0.000000191f,0.000000188f,0.000000186f,0.000000183f,0.000000180f,0.000000177f,0.000000174f,0.000000172f,0.000000169f,0.000000166f,
0.000000164f,0.000000161f,0.000000159f,0.000000156f,0.000000154f,0.000000151f,0.000000149f,0.000000147f,0.000000144f,0.000000142f,
0.000000140f,0.000000138f,0.000000136f,0.000000134f,0.000000132f,0.000000130f,0.000000128f,0.000000126f,0.000000124f,0.000000122f,
0.000000120f,0.000000118f,0.000000116f,0.000000114f,0.000000113f,
};

static
flt32_t
negativeXexp(flt32_t x)
{
	flt32_t		Y;
	uint32_t	tableIndex1;
	uint32_t	tableIndex2;
	flt32_t		X1;
	flt32_t		Y1;
	flt32_t		Y2;
#ifdef USE_MATH_SOFTMAX_EXP_FUNCTION
	Y = exp(x);
#else
	if (x > 0.0) {
		return 1.0f;
	}
	if (x > NEGATIVE_X_EXP_THRESHOLD) {
		tableIndex1 = (uint32_t)(-x * NEGATIVE_X_EXP_INV_DELTA_X);
		tableIndex2 = tableIndex1 + 1;
		if (tableIndex2 >= NEGATIVE_X_EXP_TABLE_SIZE) {
			Y = NEGATIVE_X_EXP_MAX_VALUE;
		}
		else {
			//---------------------------------------------------------------------------------------------------------------
			// 補完計算
			// 補完しない場合は、学習じなどにおいて、著しく性能が劣化する場合がある。（Kerasと同等の性能も得られない）
			//---------------------------------------------------------------------------------------------------------------
			X1 = -1.0f * NEGATIVE_X_EXP_DELTA_X * (flt32_t)tableIndex1;
			Y1 = NEGATIVE_X_EXP_TABLE[tableIndex1];
			Y2 = NEGATIVE_X_EXP_TABLE[tableIndex2];
			Y = (Y1 - Y2) * NEGATIVE_X_EXP_INV_DELTA_X * (x - X1) + Y1;	// (Y2-Y1)*-1.0f*NEGATIVE_X_EXP_INV_DELTA_X * (x - X1) + Y1
		}
	}
	else {
		Y = NEGATIVE_X_EXP_MIN_VALUE;
	}
#endif
	return Y;
}

//=====================================================================================
//  tanh関数
//=====================================================================================
//　y= (exp(x)-exp(-x))/(exp(x)+exp(-x))
//  x: -4.0 〜 4.0
//=====================================================================================
//#define USE_MATH_EXP_FUNCTION
#ifdef USE_MATH_EXP_FUNCTION
#include "math.h"
#endif

#define TANH_THRESHOLD    (4.00f)
#define TANH_TABLE_SIZE   (1025)
#define TANH_DELTA_X      (0.00390625f)	//TANH_THRESHOLD / (TANH_TABLE_SIZE-1)
#define TANH_INV_DELTA_X  (256.0f)		//(1.0/TANH_DELTA_X)
#define TANH_MAX_VALUE    (1.0f)
static const flt32_t TANH_TABLE[TANH_TABLE_SIZE] = {
0.000000000f,0.003906230f,0.007812341f,0.011718214f,0.015623729f,0.019528767f,0.023433210f,0.027336936f,0.031239832f,0.035141774f,
0.039042644f,0.042942327f,0.046840698f,0.050737645f,0.054633047f,0.058526788f,0.062418748f,0.066308811f,0.070196860f,0.074082777f,
0.077966444f,0.081847742f,0.085726567f,0.089602791f,0.093476303f,0.097346991f,0.101214729f,0.105079412f,0.108940929f,0.112799160f,
0.116653986f,0.120505311f,0.124352999f,0.128196955f,0.132037073f,0.135873228f,0.139705300f,0.143533200f,0.147356808f,0.151176021f,
0.154990733f,0.158800811f,0.162606180f,0.166406721f,0.170202315f,0.173992857f,0.177778259f,0.181558415f,0.185333207f,0.189102530f,
0.192866296f,0.196624383f,0.200376719f,0.204123184f,0.207863674f,0.211598083f,0.215326339f,0.219048321f,0.222763941f,0.226473108f,
0.230175704f,0.233871669f,0.237560868f,0.241243228f,0.244918659f,0.248587072f,0.252248347f,0.255902439f,0.259549201f,0.263188601f,
0.266820520f,0.270444870f,0.274061590f,0.277670562f,0.281271696f,0.284864962f,0.288450211f,0.292027414f,0.295596451f,0.299157232f,
0.302709728f,0.306253821f,0.309789449f,0.313316554f,0.316835016f,0.320344776f,0.323845744f,0.327337891f,0.330821127f,0.334295362f,
0.337760508f,0.341216564f,0.344663411f,0.348100960f,0.351529211f,0.354948044f,0.358357400f,0.361757219f,0.365147471f,0.368528038f,
0.371898919f,0.375259995f,0.378611237f,0.381952584f,0.385283977f,0.388605356f,0.391916662f,0.395217836f,0.398508847f,0.401789606f,
0.405060112f,0.408320278f,0.411570042f,0.414809406f,0.418038279f,0.421256602f,0.424464375f,0.427661508f,0.430848002f,0.434023768f,
0.437188774f,0.440343022f,0.443486422f,0.446618944f,0.449740559f,0.452851206f,0.455950886f,0.459039569f,0.462117165f,0.465183675f,
0.468239039f,0.471283287f,0.474316329f,0.477338135f,0.480348736f,0.483348012f,0.486336023f,0.489312679f,0.492277980f,0.495231897f,
0.498174429f,0.501105487f,0.504025161f,0.506933331f,0.509829998f,0.512715101f,0.515588760f,0.518450797f,0.521301329f,0.524140239f,
0.526967525f,0.529783249f,0.532587290f,0.535379708f,0.538160503f,0.540929556f,0.543686986f,0.546432734f,0.549166739f,0.551889122f,
0.554599702f,0.557298601f,0.559985816f,0.562661231f,0.565324962f,0.567976952f,0.570617139f,0.573245645f,0.575862408f,0.578467369f,
0.581060648f,0.583642125f,0.586211920f,0.588769913f,0.591316223f,0.593850732f,0.596373558f,0.598884642f,0.601383984f,0.603871644f,
0.606347620f,0.608811855f,0.611264408f,0.613705218f,0.616134405f,0.618551970f,0.620957792f,0.623352051f,0.625734627f,0.628105581f,
0.630464971f,0.632812738f,0.635148942f,0.637473583f,0.639786661f,0.642088234f,0.644378245f,0.646656811f,0.648923874f,0.651179433f,
0.653423607f,0.655656278f,0.657877624f,0.660087526f,0.662286103f,0.664473295f,0.666649163f,0.668813765f,0.670967102f,0.673109114f,
0.675239921f,0.677359521f,0.679467916f,0.681565166f,0.683651268f,0.685726285f,0.687790215f,0.689843059f,0.691884875f,0.693915665f,
0.695935488f,0.697944403f,0.699942350f,0.701929390f,0.703905582f,0.705870986f,0.707825482f,0.709769249f,0.711702287f,0.713624597f,
0.715536237f,0.717437148f,0.719327509f,0.721207261f,0.723076403f,0.724935055f,0.726783216f,0.728620887f,0.730448186f,0.732264996f,
0.734071493f,0.735867679f,0.737653553f,0.739429176f,0.741194546f,0.742949724f,0.744694769f,0.746429682f,0.748154461f,0.749869227f,
0.751573980f,0.753268778f,0.754953563f,0.756628513f,0.758293509f,0.759948730f,0.761594176f,0.763229787f,0.764855742f,0.766471982f,
0.768078566f,0.769675553f,0.771262944f,0.772840798f,0.774409175f,0.775968075f,0.777517617f,0.779057682f,0.780588448f,0.782109916f,
0.783622086f,0.785125017f,0.786618829f,0.788103402f,0.789578915f,0.791045368f,0.792502761f,0.793951154f,0.795390606f,0.796821117f,
0.798242748f,0.799655557f,0.801059544f,0.802454829f,0.803841352f,0.805219233f,0.806588411f,0.807949007f,0.809301078f,0.810644567f,
0.811979651f,0.813306272f,0.814624429f,0.815934300f,0.817235768f,0.818529010f,0.819814026f,0.821090817f,0.822359443f,0.823619902f,
0.824872315f,0.826116681f,0.827353060f,0.828581452f,0.829801917f,0.831014514f,0.832219243f,0.833416164f,0.834605336f,0.835786760f,
0.836960495f,0.838126600f,0.839285076f,0.840435982f,0.841579378f,0.842715263f,0.843843699f,0.844964683f,0.846078336f,0.847184658f,
0.848283648f,0.849375367f,0.850459933f,0.851537287f,0.852607489f,0.853670537f,0.854726613f,0.855775595f,0.856817603f,0.857852638f,
0.858880818f,0.859902084f,0.860916495f,0.861924171f,0.862924993f,0.863919139f,0.864906609f,0.865887403f,0.866861641f,0.867829263f,
0.868790329f,0.869744897f,0.870693028f,0.871634722f,0.872570038f,0.873498976f,0.874421597f,0.875337899f,0.876248002f,0.877151906f,
0.878049612f,0.878941238f,0.879826725f,0.880706131f,0.881579518f,0.882446885f,0.883308291f,0.884163797f,0.885013461f,0.885857224f,
0.886695147f,0.887527287f,0.888353705f,0.889174402f,0.889989436f,0.890798807f,0.891602516f,0.892400742f,0.893193364f,0.893980443f,
0.894762099f,0.895538270f,0.896309078f,0.897074461f,0.897834539f,0.898589253f,0.899338722f,0.900082946f,0.900821984f,0.901555777f,
0.902284443f,0.903007984f,0.903726459f,0.904439867f,0.905148268f,0.905851662f,0.906550109f,0.907243609f,0.907932222f,0.908615947f,
0.909294844f,0.909968913f,0.910638273f,0.911302865f,0.911962688f,0.912617862f,0.913268387f,0.913914323f,0.914555609f,0.915192366f,
0.915824533f,0.916452229f,0.917075455f,0.917694211f,0.918308556f,0.918918550f,0.919524133f,0.920125365f,0.920722306f,0.921315014f,
0.921903431f,0.922487617f,0.923067629f,0.923643470f,0.924215138f,0.924782753f,0.925346196f,0.925905645f,0.926461041f,0.927012444f,
0.927559912f,0.928103328f,0.928642869f,0.929178536f,0.929710329f,0.930238247f,0.930762351f,0.931282640f,0.931799173f,0.932311952f,
0.932820976f,0.933326364f,0.933828056f,0.934326112f,0.934820533f,0.935311317f,0.935798585f,0.936282277f,0.936762452f,0.937239170f,
0.937712312f,0.938182056f,0.938648403f,0.939111292f,0.939570844f,0.940026999f,0.940479815f,0.940929294f,0.941375554f,0.941818476f,
0.942258179f,0.942694664f,0.943127930f,0.943558037f,0.943984985f,0.944408774f,0.944829464f,0.945246994f,0.945661545f,0.946072996f,
0.946481407f,0.946886837f,0.947289288f,0.947688758f,0.948085308f,0.948478878f,0.948869586f,0.949257374f,0.949642301f,0.950024426f,
0.950403690f,0.950780153f,0.951153815f,0.951524734f,0.951892912f,0.952258348f,0.952621043f,0.952981114f,0.953338444f,0.953693151f,
0.954045236f,0.954394758f,0.954741597f,0.955085874f,0.955427647f,0.955766797f,0.956103504f,0.956437647f,0.956769347f,0.957098544f,
0.957425296f,0.957749605f,0.958071530f,0.958391011f,0.958708167f,0.959022880f,0.959335268f,0.959645391f,0.959953129f,0.960258543f,
0.960561752f,0.960862637f,0.961161315f,0.961457729f,0.961751938f,0.962043941f,0.962333739f,0.962621391f,0.962906897f,0.963190198f,
0.963471472f,0.963750541f,0.964027584f,0.964302540f,0.964575410f,0.964846253f,0.965115011f,0.965381801f,0.965646565f,0.965909362f,
0.966170192f,0.966428995f,0.966685891f,0.966940880f,0.967193961f,0.967445076f,0.967694342f,0.967941701f,0.968187213f,0.968430877f,
0.968672693f,0.968912721f,0.969150901f,0.969387293f,0.969621897f,0.969854772f,0.970085800f,0.970315158f,0.970542789f,0.970768631f,
0.970992863f,0.971215308f,0.971436143f,0.971655250f,0.971872747f,0.972088575f,0.972302794f,0.972515345f,0.972726345f,0.972935677f,
0.973143518f,0.973349690f,0.973554373f,0.973757446f,0.973959029f,0.974159062f,0.974357545f,0.974554598f,0.974750102f,0.974944115f,
0.975136697f,0.975327790f,0.975517452f,0.975705683f,0.975892425f,0.976077795f,0.976261735f,0.976444304f,0.976625502f,0.976805270f,
0.976983726f,0.977160752f,0.977336466f,0.977510870f,0.977683961f,0.977855682f,0.978026092f,0.978195250f,0.978363097f,0.978529692f,
0.978694975f,0.978859007f,0.979021847f,0.979183376f,0.979343712f,0.979502797f,0.979660690f,0.979817390f,0.979972839f,0.980127156f,
0.980280280f,0.980432272f,0.980583072f,0.980732679f,0.980881214f,0.981028557f,0.981174827f,0.981319964f,0.981463969f,0.981606901f,
0.981748700f,0.981889486f,0.982029140f,0.982167721f,0.982305288f,0.982441783f,0.982577205f,0.982711673f,0.982845008f,0.982977390f,
0.983108759f,0.983239114f,0.983368456f,0.983496785f,0.983624160f,0.983750582f,0.983875990f,0.984000504f,0.984124005f,0.984246612f,
0.984368205f,0.984488904f,0.984608710f,0.984727561f,0.984845519f,0.984962583f,0.985078692f,0.985193968f,0.985308349f,0.985421836f,
0.985534489f,0.985646248f,0.985757172f,0.985867202f,0.985976398f,0.986084759f,0.986192346f,0.986299038f,0.986404955f,0.986510038f,
0.986614287f,0.986717761f,0.986820459f,0.986922324f,0.987023473f,0.987123787f,0.987223387f,0.987322152f,0.987420201f,0.987517476f,
0.987614036f,0.987709820f,0.987804890f,0.987899184f,0.987992823f,0.988085687f,0.988177836f,0.988269329f,0.988360107f,0.988450170f,
0.988539517f,0.988628209f,0.988716185f,0.988803506f,0.988890171f,0.988976121f,0.989061475f,0.989146113f,0.989230096f,0.989313483f,
0.989396214f,0.989478290f,0.989559770f,0.989640594f,0.989720762f,0.989800334f,0.989879310f,0.989957690f,0.990035474f,0.990112603f,
0.990189195f,0.990265191f,0.990340531f,0.990415394f,0.990489602f,0.990563273f,0.990636349f,0.990708888f,0.990780830f,0.990852296f,
0.990923166f,0.990993440f,0.991063237f,0.991132498f,0.991201162f,0.991269350f,0.991337001f,0.991404116f,0.991470754f,0.991536796f,
0.991602421f,0.991667509f,0.991732061f,0.991796136f,0.991859734f,0.991922796f,0.991985440f,0.992047548f,0.992109179f,0.992170334f,
0.992231071f,0.992291272f,0.992351055f,0.992410302f,0.992469192f,0.992527544f,0.992585480f,0.992642999f,0.992700040f,0.992756605f,
0.992812812f,0.992868543f,0.992923856f,0.992978692f,0.993033171f,0.993087173f,0.993140817f,0.993193984f,0.993246794f,0.993299127f,
0.993351102f,0.993402719f,0.993453860f,0.993504643f,0.993555009f,0.993605018f,0.993654609f,0.993703842f,0.993752718f,0.993801177f,
0.993849277f,0.993896961f,0.993944347f,0.993991315f,0.994037926f,0.994084179f,0.994130075f,0.994175673f,0.994220853f,0.994265676f,
0.994310200f,0.994354308f,0.994398117f,0.994441628f,0.994484782f,0.994527578f,0.994570017f,0.994612157f,0.994654000f,0.994695485f,
0.994736671f,0.994777501f,0.994818032f,0.994858265f,0.994898200f,0.994937778f,0.994977057f,0.995016038f,0.995054781f,0.995093167f,
0.995131254f,0.995169044f,0.995206535f,0.995243728f,0.995280683f,0.995317340f,0.995353699f,0.995389760f,0.995425522f,0.995461047f,
0.995496333f,0.995531261f,0.995565951f,0.995600402f,0.995634556f,0.995668471f,0.995702088f,0.995735466f,0.995768607f,0.995801449f,
0.995834053f,0.995866418f,0.995898485f,0.995930374f,0.995961964f,0.995993316f,0.996024430f,0.996055305f,0.996085942f,0.996116340f,
0.996146560f,0.996176481f,0.996206164f,0.996235609f,0.996264875f,0.996293902f,0.996322691f,0.996351242f,0.996379554f,0.996407688f,
0.996435583f,0.996463299f,0.996490777f,0.996518016f,0.996545076f,0.996571898f,0.996598542f,0.996625006f,0.996651173f,0.996677220f,
0.996703029f,0.996728659f,0.996754050f,0.996779263f,0.996804297f,0.996829152f,0.996853769f,0.996878207f,0.996902466f,0.996926546f,
0.996950448f,0.996974111f,0.996997654f,0.997020960f,0.997044086f,0.997067094f,0.997089863f,0.997112513f,0.997134924f,0.997157216f,
0.997179270f,0.997201204f,0.997222960f,0.997244537f,0.997265935f,0.997287214f,0.997308254f,0.997329175f,0.997349977f,0.997370541f,
0.997390985f,0.997411251f,0.997431397f,0.997451365f,0.997471154f,0.997490823f,0.997510314f,0.997529685f,0.997548878f,0.997567892f,
0.997586846f,0.997605562f,0.997624218f,0.997642636f,0.997660995f,0.997679174f,0.997697175f,0.997715116f,0.997732878f,0.997750461f,
0.997767985f,0.997785330f,0.997802556f,0.997819602f,0.997836590f,0.997853398f,0.997870088f,0.997886658f,0.997903049f,0.997919381f,
0.997935534f,0.997951567f,0.997967541f,0.997983336f,0.997999012f,0.998014569f,0.998030007f,0.998045325f,0.998060524f,0.998075604f,
0.998090565f,0.998105407f,0.998120129f,0.998134732f,0.998149216f,0.998163640f,0.998177886f,0.998192072f,0.998206139f,0.998220086f,
0.998233914f,0.998247623f,0.998261273f,0.998274803f,0.998288214f,0.998301506f,0.998314738f,0.998327792f,0.998340845f,0.998353720f,
0.998366535f,0.998379230f,0.998391807f,0.998404324f,0.998416722f,0.998429060f,0.998441279f,0.998453379f,0.998465419f,0.998477340f,
0.998489201f,0.998500943f,0.998512566f,0.998524189f,0.998535633f,0.998547018f,0.998558342f,0.998569548f,0.998580635f,0.998591721f,
0.998602629f,0.998613536f,0.998624325f,0.998634994f,0.998645604f,0.998656154f,0.998666584f,0.998676956f,0.998687267f,0.998697460f,
0.998707592f,0.998717666f,0.998727620f,0.998737514f,0.998747349f,0.998757064f,0.998766720f,0.998776317f,0.998785853f,0.998795271f,
0.998804688f,0.998813987f,0.998823166f,0.998832345f,0.998841405f,0.998850405f,0.998859346f,0.998868227f,0.998877048f,0.998885751f,
0.998894453f,0.998903036f,0.998911560f,0.998920023f,0.998928428f,0.998936772f,0.998945057f,0.998953223f,0.998961389f,0.998969495f,
0.998977482f,0.998985410f,0.998993337f,0.999001145f,0.999008954f,0.999016643f,0.999024272f,0.999031901f,0.999039412f,0.999046862f,
0.999054313f,0.999061644f,0.999068975f,0.999076188f,0.999083400f,0.999090493f,0.999097586f,0.999104619f,0.999111593f,0.999118447f,
0.999125302f,0.999132156f,0.999138892f,0.999145567f,0.999152243f,0.999158800f,0.999165356f,0.999171853f,0.999178290f,0.999184668f,
0.999191046f,0.999197304f,0.999203563f,0.999209762f,0.999215901f,0.999222040f,0.999228060f,0.999234080f,0.999240041f,0.999245942f,
0.999251783f,0.999257624f,0.999263406f,0.999269128f,0.999274790f,0.999280453f,0.999286056f,0.999291599f,0.999297142f,0.999302566f,
0.999307990f,0.999313414f,0.999318719f,0.999324024f,0.999329329f,
};

static
flt32_t
hyperbolic_tangent(flt32_t x) {
	flt32_t		X;
	flt32_t		Y;
	uint32_t	tableIndex1;
	uint32_t	tableIndex2;
	flt32_t		X1;
	flt32_t		Y1;
	flt32_t		Y2;
#ifdef USE_MATH_EXP_FUNCTION
	y = (exp(x)-exp(-x))/(exp(x)+exp(-x));
#else
	if (x == 0.0f) {
		Y = 0.0f;
	}
	else if (x >= TANH_THRESHOLD) {
		Y = TANH_MAX_VALUE;
	}
	else if (x <= (-1.0f * TANH_THRESHOLD)) {
		Y = -1.0f * TANH_MAX_VALUE;
	}
	else {
		if (x < 0.0f) {
			X = -x;
		}
		else {
			X = x;
		}
		tableIndex1 = (uint32_t)(X * TANH_INV_DELTA_X);
		tableIndex2 = tableIndex1 + 1;
		// 補完計算
		X1 = TANH_DELTA_X * (flt32_t)tableIndex1;
		Y1 = TANH_TABLE[tableIndex1];
		Y2 = TANH_TABLE[tableIndex2];
		Y = (Y2 - Y1) * TANH_INV_DELTA_X * (x - X1) + Y1;
		if (x < 0.0f) {
			Y = -Y;
		}
	}
#endif
	return Y;
}

//=====================================================================================
//  WX+B layer component
//=====================================================================================
void
weight_matrix_with_bias_forward(flt32_t* pInputBuffer, uint32_t inputDim, flt32_t* pWeightMatrix, flt32_t* pBias, flt32_t* pOutputBuffer, uint32_t unit,bool_t fSuperpose) {
	uint32_t	i, j;
	flt32_t*	pOut;
	flt32_t*	pInput;
	flt32_t		outValue;
	if (fSuperpose == FALSE) {
		pOut = pOutputBuffer;
		i = unit;
		while (i--) {
			*pOut++ = 0.0f;
		}
	}
	if (pBias != NULL) {
		i = unit;
		while (i--) {
			pInput = pInputBuffer;
			outValue = *pBias++;
			j = inputDim;
			while (j--) {
				outValue += (*pInput++) * (*pWeightMatrix++);
			}
			*pOutputBuffer++ += outValue;	//バッファに出力
		}
	}
	else {
		i = unit;
		while (i--) {
			pInput = pInputBuffer;
			outValue = 0.0f;
			j = inputDim;
			while (j--) {
				outValue += (*pInput++) * (*pWeightMatrix++);
			}
			*pOutputBuffer++ += outValue;	//バッファに出力
		}
	}
}

void
weight_matrix_with_bias_backward(flt32_t* pInputBuffer, uint32_t inputDim, flt32_t* pWeightMatrix, flt32_t* pOutputBuffer, uint32_t outputDim, flt32_t* pInputX, flt32_t* pDeltaWeightMatrix, flt32_t* pDeltaBias) {
	uint32_t	i, j;
	flt32_t*	pInputValue;
	flt32_t*	pInputDelta;
	flt32_t*	pDLossArray;
	flt32_t		deltaLoss;
	//-------------------------------------------
	// dY/dW
	//-------------------------------------------
	if (pDeltaWeightMatrix != NULL) {
		i = outputDim;
		pDLossArray = pOutputBuffer;	//dL/dY
		while (i--) {
			deltaLoss = *pDLossArray++;
			pInputValue = pInputX;		//順伝搬入力
			j = inputDim;
			while (j--) {
				*pDeltaWeightMatrix++ += (*pInputValue++) * deltaLoss;
			}
		}
	}
	//-------------------------------------------
	// dY/dB
	//-------------------------------------------
	if (pDeltaBias != NULL) {
		i = outputDim;
		pDLossArray = pOutputBuffer;
		while (i--) {
			*pDeltaBias++ += (*pDLossArray++);
		}
	}
	//-------------------------------------------
	// dY/dX
	//-------------------------------------------
	if (pInputBuffer != NULL) {
		//逆伝搬する微分値の計算：累積
		i = outputDim;
		pDLossArray = pOutputBuffer;	//dL/dY
		while (i--) {
			deltaLoss = *pDLossArray++;
			pInputDelta = pInputBuffer;	//逆伝搬微分値
			j = inputDim;
			while (j--) {
				*pInputDelta++ += (*pWeightMatrix++) * deltaLoss;
			}
		}
	}
}

//=====================================================================================
//  relu activation
//=====================================================================================
void
relu_forward(flt32_t* pInputBuffer, flt32_t* pOutputBuffer, uint32_t dim,flt32_t alpha) {
	uint32_t	i;
	i = dim;
	while( i--){
		if (*pInputBuffer > 0.0f) {
			*pOutputBuffer = *pInputBuffer;
		}
		else {
			*pOutputBuffer = alpha * (*pInputBuffer);
		}
		pInputBuffer++;
		pOutputBuffer++;
	}
}

void
relu_backword(flt32_t* pX, flt32_t* pLoss, flt32_t* pInput, uint32_t dim, flt32_t alpha) {
	while (dim--) {
		if (*pX > 0.0f) {
			*pInput = (*pLoss);
		}
		else {
			*pInput = alpha * (*pLoss);
		}
		pX++;
		pInput++;
		pLoss++;
	}
}

//=====================================================================================
//  tanh activation
//=====================================================================================
void
tanh_forward(flt32_t* pInputBuffer, flt32_t* pOutputBuffer, uint32_t dim) {
	uint32_t	i;
	flt32_t	x;
	flt32_t	y;
	flt32_t*	pOutputValue = pOutputBuffer;
	flt32_t*	pInputValue = pInputBuffer;
	pInputValue = pInputBuffer;
	pOutputValue = pOutputBuffer;
	i = dim;
	while (i--) {
		x = *pInputValue++;
		y = hyperbolic_tangent(x);
		*pOutputValue++ = y;
	}
}

void
tanh_backword(flt32_t* pY, flt32_t* pLoss, flt32_t* pInput, uint32_t dim) {
	//1 - y*y
	while (dim--) {
		*pInput++ = (*pLoss++) * (1.0f - (*pY) * (*pY));
		pY++;
	}
}

//=====================================================================================
//  sigmoid activation
//=====================================================================================
void
sigmoid_forward(flt32_t* pInputBuffer, flt32_t* pOutputBuffer, uint32_t dim) {
	uint32_t	i;
	flt32_t		x;
	flt32_t		y;
	i = dim;
	while (i--) {
		x = *pInputBuffer++;
		y = sigmoid(x);
		*pOutputBuffer++ = y;
	}
}

void
sigmoid_backword(flt32_t* pY, flt32_t* pLoss, flt32_t* pInput, uint32_t dim) {
	while (dim--) {
		*pInput++ = (*pLoss++) * (*pY) * (1.0f - (*pY));
		pY++;
	}
}

//=====================================================================================
//  softmax activation
//=====================================================================================
#define SOFTMAX_MINEXPVALUE		(-1e20f) 
#define SOFTMAX_THRESHOLD		(1e-8f)

void
softmax_forward(flt32_t* pInputBuffer, flt32_t* pOutputBuffer, uint32_t dim) {
	uint32_t	i;
	flt32_t		x;
	flt32_t		y;
	flt32_t		factor;
	flt32_t*	pOutputValue	= pOutputBuffer;
	flt32_t		maxValue		= SOFTMAX_MINEXPVALUE;
	flt32_t		sumValue		= 0.0f;
	flt32_t*	pInputValue		= pInputBuffer;
	flt32_t		outVlaue;
	//---------------------------------------------------------------------------------
	//max
	//---------------------------------------------------------------------------------
	i = dim;
	while (i--) {
		if (*pInputValue > maxValue) {
			maxValue = *pInputValue;
		}
		pInputValue++;
	}
	//---------------------------------------------------------------------------------
	//maxからの距離でexp
	//---------------------------------------------------------------------------------
	pInputValue		= pInputBuffer;
	pOutputValue	= pOutputBuffer;
	i = dim;
	while (i--) {
		x = *pInputValue++ - maxValue;
		y = negativeXexp(x);
		*pOutputValue = y;
		sumValue += *pOutputValue++;
	}
	if (sumValue == 0.0f) {
		return;
	}
	//---------------------------------------------------------------------------------
	//正規化
	//---------------------------------------------------------------------------------
	factor = 1.0f / sumValue;
	pOutputValue = pOutputBuffer;
	i = dim;
	while (i--) {
		outVlaue = *pOutputValue * factor;
		if (outVlaue < SOFTMAX_THRESHOLD) {
			outVlaue = 0.0f;
		}
		*pOutputValue++ = outVlaue;
	}
}

void
softmax_backword(flt32_t* pY, flt32_t* pLoss, flt32_t* pInput, uint32_t dim) {
	while (dim--) {
		*pInput++ = (*pLoss++) * (*pY) * (1.0f - (*pY));
		pY++;
	}
}

//=====================================================================================
//low cost SQRT (IEEE754)
//=====================================================================================
flt32_t low_cost_sqrt(const flt32_t x, uint32_t iterlations)
{
	flt32_t		xHalf	= 0.5f * x;
	int32_t		tmp		= 0x5F3759DF - (*(int32_t*)&x >> 1); //initial guess
	flt32_t		xRes	= *(flt32_t*)&tmp;
	while (iterlations--) {
		xRes *= (1.5f - (xHalf * xRes * xRes));
	}
	return (xRes * x);
}

//-------------------------------------------------------------------------
//初期値取得
//-------------------------------------------------------------------------
void
set_random_initial_values(handle_t hRandomValueGenerator, flt32_t* pParameterArray, uint32_t arraySize, flt32_t factor) {
	uint32_t i;
	flt32_t* pParameter;
	i = arraySize;
	pParameter = pParameterArray;
	while (i--) {
		*pParameter++ = RandomValueGenerator_getFloatingPointValue(hRandomValueGenerator, factor);
	}
}

//-------------------------------------------------------------------------
//初期値設定:sqrt normalization
//-------------------------------------------------------------------------
void
set_random_initial_values_by_sqrt(handle_t hRandomValueGenerator, flt32_t* pParameterArray, uint32_t arraySize, uint32_t normSize) {
	uint32_t   i;
	flt32_t* pParameter;
	flt32_t    factor;
	i = arraySize;
	pParameter = pParameterArray;
	factor = 1.0f / (flt32_t)(normSize);
	factor = low_cost_sqrt(factor, 1);
	while (i--) {
		*pParameter++ = RandomValueGenerator_getFloatingPointValue(hRandomValueGenerator, factor);
	}
}

//-------------------------------------------------------------------------
//初期値設定:constant value
//-------------------------------------------------------------------------
void
set_constant_initial_values(flt32_t* pParameterArray, uint32_t arraySize, flt32_t value) {
	uint32_t   i;
	flt32_t* pParameter;
	i = arraySize;
	pParameter = pParameterArray;
	while (i--) {
		*pParameter++ = value;
	}
}
